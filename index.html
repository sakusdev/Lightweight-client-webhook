<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Discord Webhook Tool</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; }
    button { padding: 10px; margin-right: 10px; cursor: pointer; }
    .webhook-entry { margin-bottom: 5px; }
    .settings { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    .hidden { display: none; }
    #settingsPanel { background: #f0f0f0; padding: 10px; border: 1px solid #999; }
    #toggleSettings { background: #ff9800; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Discord Webhook 送信ツール</h2>

  <label>Webhook URL(s):</label>
  <div id="webhooks"></div>
  <input type="text" id="newWebhook" placeholder="Webhook URL を追加" />
  <button onclick="addWebhook()">追加</button>

  <label>通常メッセージ:</label>
  <textarea id="message" rows="4" placeholder="通常メッセージ（Embedと併用可）"></textarea>

  <label>Embedタイトル:</label>
  <input type="text" id="embedTitle" placeholder="例: お知らせ" />
  <label>Embed説明:</label>
  <textarea id="embedDescription" rows="3" placeholder="Embedの本文"></textarea>

  <button onclick="sendMessages()">送信</button>
  <button onclick="startLoop()">定期送信開始</button>
  <button onclick="stopLoop()">停止</button>
  <br/><br/>
  <label>ファイルアップロード:</label>
  <input type="file" id="fileInput" />
  <button onclick="uploadToGitHub()">GitHubへアップしてURL送信</button>

  <br/><br/>
  <button id="toggleSettings" onclick="toggleSettings()">▼ 設定（GitHub Token等）</button>

  <div id="settingsPanel" class="hidden">
    <label>GitHub Token:</label>
    <input type="password" id="githubToken" placeholder="repo スコープ付きToken" />
    <label>GitHubリポジトリ（user/repo）:</label>
    <input type="text" id="githubRepo" placeholder="例: yourname/yourrepo" />
    <button onclick="saveSettings()">保存</button>
  </div>

  <script>
    // 初期設定
    let loopInterval = null;

    // 保存されたWebhook読み込み
    const webhookList = JSON.parse(localStorage.getItem('webhooks') || '[]');
    const webhooksDiv = document.getElementById('webhooks');
    webhookList.forEach(url => createWebhookEntry(url));

    function createWebhookEntry(url) {
      const div = document.createElement('div');
      div.className = 'webhook-entry';
      div.textContent = url;
      webhooksDiv.appendChild(div);
    }

    function addWebhook() {
      const url = document.getElementById('newWebhook').value;
      if (url) {
        webhookList.push(url);
        localStorage.setItem('webhooks', JSON.stringify(webhookList));
        createWebhookEntry(url);
        document.getElementById('newWebhook').value = '';
      }
    }

    function buildPayload() {
      const message = document.getElementById('message').value;
      const embedTitle = document.getElementById('embedTitle').value;
      const embedDescription = document.getElementById('embedDescription').value;
      const embeds = [];

      if (embedTitle || embedDescription) {
        embeds.push({
          title: embedTitle,
          description: embedDescription,
          color: 5814783
        });
      }

      return {
        content: message || null,
        embeds: embeds.length ? embeds : undefined
      };
    }

    async function sendMessages() {
      const payload = buildPayload();
      for (const url of webhookList) {
        try {
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (err) {
          alert(`送信エラー: ${url}`);
        }
      }
    }

    function startLoop() {
      if (loopInterval) return;
      loopInterval = setInterval(sendMessages, 5000);
    }

    function stopLoop() {
      clearInterval(loopInterval);
      loopInterval = null;
    }

    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      panel.classList.toggle('hidden');
    }

    function saveSettings() {
      localStorage.setItem('githubToken', document.getElementById('githubToken').value);
      localStorage.setItem('githubRepo', document.getElementById('githubRepo').value);
      alert("保存しました！");
    }

    async function uploadToGitHub() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("ファイルを選択してください");

      const token = localStorage.getItem('githubToken');
      const repo = localStorage.getItem('githubRepo');
      if (!token || !repo) return alert("GitHubトークンとリポジトリを設定してください");

      const content = await file.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(content)));
      const filename = file.name;
      const path = `uploads/${Date.now()}_${filename}`;

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${filename}`,
          content: base64
        })
      });

      const json = await res.json();
      if (json.content && json.content.download_url) {
        const url = json.content.download_url;
        document.getElementById('message').value = url;
        sendMessages();
      } else {
        alert("アップロード失敗: " + JSON.stringify(json));
      }
    }
  </script>
</body>
</html>
