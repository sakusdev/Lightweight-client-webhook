<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LWCWD - Lightweight Client Webhook for Discord</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; }
    button { padding: 10px; margin: 5px 5px 5px 0; cursor: pointer; }
    .webhook-entry { margin-bottom: 5px; }
    .hidden { display: none; }
    #settingsPanel { background: #f9f9f9; border: 1px solid #ccc; padding: 10px; }
    #toggleSettings { background: #ff5722; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <h2>LWCWD - Lightweight Client Webhook for Discord</h2>

  <label>Webhook URL 一覧:</label>
  <div id="webhooks"></div>
  <input type="text" id="newWebhook" placeholder="Webhook URL を追加" />
  <button onclick="addWebhook()">追加</button>

  <label>通常メッセージ:</label>
  <textarea id="message" rows="4" placeholder="通常メッセージ（Embedと併用可）"></textarea>

  <label>Embedタイトル:</label>
  <input type="text" id="embedTitle" placeholder="例: 通知" />
  <label>Embed説明:</label>
  <textarea id="embedDescription" rows="3" placeholder="Embed本文"></textarea>

  <label>定期送信間隔（秒）:</label>
  <input type="number" id="loopIntervalSec" value="5" min="1" />

  <button onclick="sendMessages()">送信</button>
  <button onclick="startLoop()">定期送信開始</button>
  <button onclick="stopLoop()">停止</button>

  <br/><br/>
  <label>ファイルアップロード:</label>
  <input type="file" id="fileInput" />
  <button onclick="uploadToGitHub()">GitHubへアップ＆URL送信</button>

  <br/><br/>
  <button id="toggleSettings" onclick="toggleSettings()">▼ 設定（GitHub Token等）</button>
  <div id="settingsPanel" class="hidden">
    <label>GitHub Token（repo権限必要）:</label>
    <input type="password" id="githubToken" placeholder="ghp_..." />
    <label>GitHub リポジトリ（user/repo）:</label>
    <input type="text" id="githubRepo" placeholder="yourname/yourrepo" />
    <button onclick="saveSettings()">保存</button>
  </div>

  <script>
    let loopInterval = null;

    const webhookList = JSON.parse(localStorage.getItem('webhooks') || '[]');
    const webhooksDiv = document.getElementById('webhooks');
    webhookList.forEach(url => createWebhookEntry(url));

    function createWebhookEntry(url) {
      const div = document.createElement('div');
      div.className = 'webhook-entry';
      div.textContent = url;
      webhooksDiv.appendChild(div);
    }

    function addWebhook() {
      const url = document.getElementById('newWebhook').value;
      if (url) {
        webhookList.push(url);
        localStorage.setItem('webhooks', JSON.stringify(webhookList));
        createWebhookEntry(url);
        document.getElementById('newWebhook').value = '';
      }
    }

    function buildPayload() {
      const message = document.getElementById('message').value;
      const embedTitle = document.getElementById('embedTitle').value;
      const embedDescription = document.getElementById('embedDescription').value;
      const embeds = [];

      if (embedTitle || embedDescription) {
        embeds.push({
          title: embedTitle,
          description: embedDescription,
          color: 5814783
        });
      }

      return {
        content: message || null,
        embeds: embeds.length ? embeds : undefined
      };
    }

    async function sendMessages() {
      const payload = buildPayload();
      for (const url of webhookList) {
        try {
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (err) {
          alert(`送信エラー: ${url}`);
        }
      }
    }

    function startLoop() {
      if (loopInterval) return;
      const intervalSec = parseInt(document.getElementById('loopIntervalSec').value, 10);
      if (isNaN(intervalSec) || intervalSec < 1) {
        alert("1秒以上の間隔を入力してください。");
        return;
      }
      loopInterval = setInterval(sendMessages, intervalSec * 1000);
    }

    function stopLoop() {
      clearInterval(loopInterval);
      loopInterval = null;
    }

    function toggleSettings() {
      const panel = document.getElementById('settingsPanel');
      panel.classList.toggle('hidden');
    }

    function saveSettings() {
      localStorage.setItem('githubToken', document.getElementById('githubToken').value);
      localStorage.setItem('githubRepo', document.getElementById('githubRepo').value);
      alert("設定を保存しました。");
    }

    async function uploadToGitHub() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("ファイルを選択してください。");

      const token = localStorage.getItem('githubToken');
      const repo = localStorage.getItem('githubRepo');
      if (!token || !repo) return alert("GitHubの設定を完了してください。");

      const content = await file.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(content)));
      const filename = file.name;
      const path = `uploads/${Date.now()}_${filename}`;

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${filename}`,
          content: base64
        })
      });

      const json = await res.json();
      if (json.content && json.content.download_url) {
        document.getElementById('message').value = json.content.download_url;
        sendMessages();
      } else {
        alert("アップロード失敗：" + JSON.stringify(json));
      }
    }
  </script>
</body>
</html>
