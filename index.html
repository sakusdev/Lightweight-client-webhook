<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LWCWD - Lightweight Webhook Client</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input, select { width: 100%; margin-top: 4px; }
    .section { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    .webhook-item { margin-top: 4px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>LWCWD - Webhook クライアント</h1>

  <div class="section">
    <h3>Webhook 管理</h3>
    <input id="newWebhook" placeholder="Webhook URLを入力" />
    <button onclick="addWebhook()">追加</button>
    <div id="webhookList"></div>
  </div>

  <div class="section">
    <h3>GitHub 設定</h3>
    <input id="githubToken" placeholder="GitHub Token (保存されます)" />
    <input id="githubRepo" placeholder="GitHub Repo (user/repo)" />
    <button onclick="saveSettings()">設定を保存</button>
  </div>

  <div class="section">
    <h3>メッセージ送信</h3>
    <textarea id="message" placeholder="通常メッセージ"></textarea>
    <textarea id="embedJson" placeholder="埋め込みJSON"></textarea>
    <input type="file" id="uploadFile" />
    <br><br>
    <button onclick="sendNow()">送信</button>
    <label>
      <input type="checkbox" id="loopCheck"> 定期送信
    </label>
    <input type="number" id="interval" value="10" min="1" /> 秒ごと
  </div>

  <script>
    const webhookKey = "lwcwd_webhooks";
    const tokenKey = "lwcwd_token";
    const repoKey = "lwcwd_repo";
    let loopId = null;

    function loadWebhooks() {
      const data = JSON.parse(localStorage.getItem(webhookKey) || "[]");
      const list = document.getElementById("webhookList");
      list.innerHTML = "";
      data.forEach((item, i) => {
        const el = document.createElement("div");
        el.className = "webhook-item";
        el.innerHTML = `
          <input type="checkbox" id="webhook_${i}" checked />
          <input value="${item.name}" onchange="editWebhookName(${i}, this.value)" />
          <input value="${item.url}" onchange="editWebhookUrl(${i}, this.value)" />
          <button onclick="deleteWebhook(${i})">削除</button>
        `;
        list.appendChild(el);
      });
    }

    function addWebhook() {
      const url = document.getElementById("newWebhook").value;
      if (!url) return;
      const data = JSON.parse(localStorage.getItem(webhookKey) || "[]");
      data.push({ name: `Webhook ${data.length + 1}`, url });
      localStorage.setItem(webhookKey, JSON.stringify(data));
      document.getElementById("newWebhook").value = "";
      loadWebhooks();
    }

    function editWebhookName(i, name) {
      const data = JSON.parse(localStorage.getItem(webhookKey));
      data[i].name = name;
      localStorage.setItem(webhookKey, JSON.stringify(data));
    }

    function editWebhookUrl(i, url) {
      const data = JSON.parse(localStorage.getItem(webhookKey));
      data[i].url = url;
      localStorage.setItem(webhookKey, JSON.stringify(data));
    }

    function deleteWebhook(i) {
      const data = JSON.parse(localStorage.getItem(webhookKey));
      data.splice(i, 1);
      localStorage.setItem(webhookKey, JSON.stringify(data));
      loadWebhooks();
    }

    function saveSettings() {
      localStorage.setItem(tokenKey, document.getElementById("githubToken").value);
      localStorage.setItem(repoKey, document.getElementById("githubRepo").value);
      alert("保存しました");
    }

    async function sendNow() {
      const msg = document.getElementById("message").value;
      const embed = document.getElementById("embedJson").value;
      const file = document.getElementById("uploadFile").files[0];
      const data = JSON.parse(localStorage.getItem(webhookKey) || "[]");
      const selected = data.filter((_, i) => document.getElementById("webhook_" + i)?.checked);

      let content = { content: msg };
      if (embed) {
        try {
          content.embeds = [JSON.parse(embed)];
        } catch {
          alert("埋め込みJSONが無効です");
          return;
        }
      }

      // アップロード処理
      if (file) {
        const token = localStorage.getItem(tokenKey);
        const repo = localStorage.getItem(repoKey);
        const reader = new FileReader();
        reader.onload = async () => {
          const arr = new Uint8Array(reader.result);
          const binary = Array.from(arr).map(b => String.fromCharCode(b)).join("");
          const base64 = btoa(binary);
          const path = `uploads/${file.name}`;
          const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `upload ${file.name}`,
              content: base64
            })
          });
          const json = await res.json();
          const url = json.content?.download_url || json.html_url;
          if (url) content.content += `\n[ファイル](${url})`;
          postToWebhooks(content, selected);
        };
        reader.readAsArrayBuffer(file);
      } else {
        postToWebhooks(content, selected);
      }
    }

    function postToWebhooks(payload, targets) {
      targets.forEach(w => {
        fetch(w.url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      });
    }

    document.getElementById("loopCheck").addEventListener("change", e => {
      if (e.target.checked) {
        loopId = setInterval(sendNow, parseInt(document.getElementById("interval").value) * 1000);
      } else {
        clearInterval(loopId);
      }
    });

    // 初期化
    document.getElementById("githubToken").value = localStorage.getItem(tokenKey) || "";
    document.getElementById("githubRepo").value = localStorage.getItem(repoKey) || "";
    loadWebhooks();
  </script>
</body>
</html>
