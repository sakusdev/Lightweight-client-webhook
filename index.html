<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Lightweight Client Webhook for Discord (LWCWD)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    input, button, textarea, select {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .webhook-entry {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }
    #token-section { display: none; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>LWCWD - Webhookクライアント</h2>

  <h3>Webhook URL 管理</h3>
  <input id="newWebhook" type="text" placeholder="Webhook URL">
  <button onclick="addWebhook()">追加</button>
  <div id="webhooksDiv"></div>

  <h3>送信内容</h3>
  <textarea id="message" rows="4" cols="60" placeholder="メッセージまたは埋め込み説明"></textarea><br>
  <input id="embedTitle" type="text" placeholder="Embedタイトル">
  <input id="embedColor" type="color" value="#0099ff"><br>
  <button onclick="sendMessage()">通常メッセージ送信</button>
  <button onclick="sendEmbed()">埋め込み送信</button>

  <h3>定期送信</h3>
  <input id="intervalSec" type="number" value="5" min="1"> 秒ごとに送信
  <button onclick="startLoop()">開始</button>
  <button onclick="stopLoop()">停止</button>

  <h3>GitHubにファイルアップロード＆共有</h3>
  <input type="file" id="fileInput">
  <button onclick="uploadFileToGitHub()">アップロードして送信</button>

  <h3>設定</h3>
  <button onclick="toggleToken()">トークン設定</button>
  <div id="token-section">
    <input type="password" id="githubToken" placeholder="GitHubトークン">
    <button onclick="saveToken()">保存</button>
  </div>

  <script>
    const webhooksDiv = document.getElementById("webhooksDiv");
    const messageBox = document.getElementById("message");
    const embedTitle = document.getElementById("embedTitle");
    const embedColor = document.getElementById("embedColor");
    let webhookList = JSON.parse(localStorage.getItem("webhooks") || "[]");
    let loopId = null;

    function renderWebhooks() {
      webhooksDiv.innerHTML = '';
      webhookList.forEach((url, index) => createWebhookEntry(url, index));
    }

    function createWebhookEntry(url, index) {
      const div = document.createElement('div');
      div.className = 'webhook-entry';

      const input = document.createElement('input');
      input.type = 'text';
      input.value = url;
      input.style.width = '60%';

      const saveBtn = document.createElement('button');
      saveBtn.textContent = '保存';
      saveBtn.onclick = () => {
        webhookList[index] = input.value;
        localStorage.setItem("webhooks", JSON.stringify(webhookList));
        alert("Webhookを更新しました");
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '削除';
      deleteBtn.onclick = () => {
        webhookList.splice(index, 1);
        localStorage.setItem("webhooks", JSON.stringify(webhookList));
        renderWebhooks();
      };

      div.appendChild(input);
      div.appendChild(saveBtn);
      div.appendChild(deleteBtn);
      webhooksDiv.appendChild(div);
    }

    function addWebhook() {
      const url = document.getElementById("newWebhook").value;
      if (url) {
        webhookList.push(url);
        localStorage.setItem("webhooks", JSON.stringify(webhookList));
        renderWebhooks();
        document.getElementById("newWebhook").value = "";
      }
    }

    async function sendToAll(payload) {
      for (const url of webhookList) {
        try {
          await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          alert("送信失敗: " + url);
        }
      }
    }

    function sendMessage() {
      const msg = messageBox.value;
      if (!msg) return alert("メッセージを入力してください");
      sendToAll({ content: msg });
    }

    function sendEmbed() {
      const title = embedTitle.value;
      const desc = messageBox.value;
      const color = parseInt(embedColor.value.replace("#", "0x"));
      if (!desc && !title) return alert("内容を入力してください");

      const embed = {
        title: title || undefined,
        description: desc,
        color: color
      };
      sendToAll({ embeds: [embed] });
    }

    function startLoop() {
      const interval = parseInt(document.getElementById("intervalSec").value) * 1000;
      if (loopId) clearInterval(loopId);
      loopId = setInterval(() => {
        const msg = messageBox.value;
        if (msg) sendToAll({ content: msg });
      }, interval);
    }

    function stopLoop() {
      clearInterval(loopId);
      loopId = null;
    }

    function toggleToken() {
      const section = document.getElementById("token-section");
      section.style.display = section.style.display === "none" ? "block" : "none";
    }

    function saveToken() {
      const token = document.getElementById("githubToken").value;
      if (token) {
        localStorage.setItem("githubToken", token);
        alert("GitHubトークンを保存しました");
      }
    }

    async function uploadFileToGitHub() {
      const file = document.getElementById("fileInput").files[0];
      const token = localStorage.getItem("githubToken");
      if (!file || !token) return alert("ファイルとトークンが必要です");

      const repo = "YOUR_USERNAME/YOUR_REPO"; // ← ここを自分のリポジトリに変更
      const path = "uploads/" + file.name;

      const reader = new FileReader();
      reader.onload = async () => {
        const content = btoa(reader.result);
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
          method: "PUT",
          headers: {
            Authorization: "token " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "upload via LWCWD",
            content: content
          })
        });
        const data = await res.json();
        if (data.content && data.content.download_url) {
          messageBox.value = data.content.download_url;
          sendMessage();
        } else {
          alert("アップロードに失敗しました");
        }
      };
      reader.readAsBinaryString(file);
    }

    renderWebhooks();
  </script>
</body>
</html>
